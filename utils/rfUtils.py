import time
import random
import numpy as np
import math
from python_hackrf import pyhackrf  
import utils.modes as modes
from utils.config import *
import utils.motorUtils as motorUtils
import threading
import subprocess

# Global variable to keep track of the current scan section
baseline_avgs = {}   # Baseline averages for the 101 sections
rssi = -1000  # Global variable to store the latest RSSI value
rssi_lst = [-1000]*5
comp_value = 0  # Global variable to store the latest baseline subtracted value
sdr = None
rxStream = None


# -----------------------------
# Settings
# -----------------------------
sample_rate = 15e6
baseband_filter = 7.5e6
lna_gain = 30
vga_gain = 50

# -----------------------------
# Internal state
# -----------------------------
_sdr = None
_lock = threading.Lock()
_done = threading.Event()
_target = 0
_seen = 0
_power_sum = 0.0


def _rx_callback(device, buffer, buffer_length, valid_length):
    global _seen, _power_sum

    b = buffer[:valid_length].astype(np.int8)
    iq = b[0::2].astype(np.float32) + 1j * b[1::2].astype(np.float32)
    iq *= (1.0 / 128.0)

    with _lock:
        _power_sum += float(np.vdot(iq, iq).real)
        _seen += iq.size
        if _seen >= _target:
            _done.set()

    return 0

def setupHackRF():
    global _sdr
    pyhackrf.pyhackrf_init()
    _sdr = pyhackrf.pyhackrf_open()

    bw = pyhackrf.pyhackrf_compute_baseband_filter_bw_round_down_lt(baseband_filter)

    _sdr.pyhackrf_set_sample_rate(sample_rate)
    _sdr.pyhackrf_set_baseband_filter_bandwidth(bw)
    _sdr.pyhackrf_set_antenna_enable(False)
    _sdr.pyhackrf_set_amp_enable(False)
    _sdr.pyhackrf_set_lna_gain(lna_gain)
    _sdr.pyhackrf_set_vga_gain(vga_gain)

    _sdr.set_rx_callback(_rx_callback)

def closeHackRF():
    global _sdr
    if _sdr:
        try:
            _sdr.pyhackrf_stop_rx()
        except Exception:
            pass
        try:
            _sdr.pyhackrf_close()
        except Exception:
            pass
    pyhackrf.pyhackrf_exit()
    _sdr = None

def set_freq(freq_hz: float):
    _sdr.pyhackrf_set_freq(freq_hz)
    time.sleep(0.02)  

def readRssi(num_samples: int = 250_000) -> float | None:
    """
    Returns RSSI as wideband power in dBFS.
    """
    global _seen, _power_sum, _target, rssi, rssi_lst

    with _lock:
        _seen = 0
        _power_sum = 0.0
        _target = num_samples
    _done.clear()
    for i in range(50):
        _sdr.pyhackrf_start_rx()
        ok = _done.wait(timeout=2.0)
        try:
            _sdr.pyhackrf_stop_rx()
        except Exception:
            pass

        if not ok:
            return None

        with _lock:
            if _seen == 0 or _power_sum <= 0:
                return None
            mean_power = _power_sum / _seen

        rssi = 10.0 * math.log10(mean_power + 1e-12)
        if rssi != None:
            break
    rssi_lst.append(rssi)
    rssi_lst.remove(rssi_lst[0])
    return rssi

# Dont read just return latest reading
def getRssi():
    global rssi_lst
    avg_rssi = sum(rssi_lst) / len(rssi_lst)
    return avg_rssi

# Don't calculate just return latest reading with baseline subtracted
def getCompValue():
    global comp_value
    return comp_value

# Function to scan for every section and iterate through sections
def scanBaseline():
    global baseline_avgs
    baseline_avgs = {'0_0': -22.4987416621953, '9_0': -22.49916664106514, '9_9': -18.96751883654485, '9_18': -22.465848165328737, '9_27': -22.408498480617148, '9_36': -22.25848405878955, '9_45': -22.457284744218665, '9_54': -22.462935951654217, '9_63': -22.414228085031198, '9_72': -22.432550187202143, '9_81': -22.33862281969018, '9_90': -22.446991277381994, '9_99': -22.411088530924786, '9_108': -22.21929815513837, '9_117': -22.291372433820605, '9_126': -22.441507185244355, '9_135': -22.402958592779953, '9_144': -22.389372405095862, '9_153': -22.431693382207566, '9_162': -21.9080044362404, '9_171': -21.29834648392219, '9_180': -22.45842574854633, '9_189': -22.429145917085037, '9_198': -20.934938882891277, '9_207': -22.381035818973018, '9_216': -22.44246884742607, '9_225': -22.462458883638764, '9_234': -22.41596884720261, '9_243': -22.352646898723624, '9_252': -22.409388230794214, '9_261': -22.504119703752536, '9_270': -22.416203776568263, '9_279': -22.402803152058862, '9_288': -22.453190531195947, '9_297': -22.46870716905029, '9_306': -22.44998957244757, '9_315': -22.42657112691793, '9_324': -22.34123629704189, '9_333': -22.465478523989155, '9_342': -22.397157603485137, '9_351': -22.404240311589252, '18_0': -22.30149516397731, '18_9': -21.99644010209033, '18_18': -22.409075837812125, '18_27': -22.428806096709497, '18_36': -22.463320175691216, '18_45': -22.467848377854235, '18_54': -22.18819620439854, '18_63': -22.376372081198586, '18_72': -22.419681229355387, '18_81': -22.424796597156597, '18_90': -22.40241246476657, '18_99': -22.26676126432979, '18_108': -22.26005714442547, '18_117': -22.3336359289707, '18_126': -22.46372779342902, '18_135': -22.382510245738164, '18_144': -22.36992967426881, '18_153': -22.43258736645195, '18_162': -22.306055582408412, '18_171': -22.462885853484433, '18_180': -22.462554613936714, '18_189': -22.484702293404588, '18_198': -22.43793386828189, '18_207': -22.518030324108413, '18_216': -22.515810875780783, '18_225': -22.44240053044786, '18_234': -22.31973804031805, '18_243': -22.395989802689282, '18_252': -22.452299232358186, '18_261': -22.43585684390707, '18_270': -22.46373813593403, '18_279': -22.475865605712944, '18_288': -22.364657299350466, '18_297': -22.42210887369763, '18_306': -22.449077959415806, '18_315': -22.351038184263846, '18_324': -22.378038288370714, '18_333': -22.425558005925744, '18_342': -22.391356636021882, '18_351': -22.25751024592372, '27_0': -22.26047692303315, '27_9': -22.17208553808646, '27_18': -22.303758618776342, '27_27': -22.389962652816997, '27_36': -22.475133944467313, '27_45': -22.426964877734253, '27_54': -22.39691053238204, '27_63': -22.477407826332897, '27_72': -22.43684383828394, '27_81': -22.329427329902146, '27_90': -22.380280076220423, '27_99': -22.347731217320582, '27_108': -22.287418084544747, '27_117': -22.372700362112884, '27_126': -22.346041363911358, '27_135': -22.3457685493874, '27_144': -21.513926094829277, '27_153': -22.400126540953295, '27_162': -22.440172566491686, '27_171': -21.856453569113043, '27_180': -22.487618266632232, '27_189': -22.46214478898979, '27_198': -22.294225486929076, '27_207': -22.43960932578059, '27_216': -22.450590250318303, '27_225': -22.494338460409438, '27_234': -22.347500830848055, '27_243': -22.370116402735725, '27_252': -22.32865043654882, '27_261': -22.472685957018935, '27_270': -22.262402605150132, '27_279': -22.457392646578725, '27_288': -22.37595929904534, '27_297': -22.410729451471152, '27_306': -22.31255368941519, '27_315': -20.061676109920352, '27_324': -22.377631116836238, '27_333': -22.433382724539605, '27_342': -22.352937354563327, '27_351': -22.186902057638825, '36_0': -22.35692730841904, '36_9': -22.35965785106556, '36_18': -22.346641373189545, '36_27': -22.394904105163064, '36_36': -22.436200405906476, '36_45': -22.4068374441171, '36_54': -22.335233361625733, '36_63': -22.465081622733777, '36_72': -22.413231587061553, '36_81': -21.691910593703184, '36_90': -22.392220604144523, '36_99': -22.40498809697774, '36_108': -22.433090556936115, '36_117': -22.334322152405534, '36_126': -22.180394836582327, '36_135': -22.252290652099923, '36_144': -22.423979603911462, '36_153': -22.05052434442902, '36_162': -22.448366433475314, '36_171': -22.434254563252658, '36_180': -22.42585691479633, '36_189': -22.48419613340243, '36_198': -22.35994094132788, '36_207': -22.49158277977272, '36_216': -22.407522659112324, '36_225': -21.16680604846963, '36_234': -22.235517571520024, '36_243': -22.220471659135494, '36_252': -22.368483760282672, '36_261': -22.374454776358537, '36_270': -22.424257788464196, '36_279': -22.44053615801297, '36_288': -22.42419187778831, '36_297': -22.432502031694543, '36_306': -21.18250865136664, '36_315': -22.45683517990623, '36_324': -22.406326727408477, '36_333': -22.438769920561246, '36_342': -22.366505590530824, '36_351': -22.34580568725257, '45_0': -22.287124615429626, '45_9': -22.36074225992833, '45_18': -22.385792143169013, '45_27': -22.431482747362367, '45_36': -22.32851889359999, '45_45': -22.370819585984457, '45_54': -22.438566388348796, '45_63': -22.358729145126645, '45_72': -22.2106274985285, '45_81': -22.44835861515645, '45_90': -22.39521214535356, '45_99': -22.295471564043353, '45_108': -22.41330878853324, '45_117': -22.389626585696586, '45_126': -22.050702534494082, '45_135': -22.324028081397394, '45_144': -22.314089977969882, '45_153': -22.381242971431522, '45_162': -22.47369976689786, '45_171': -22.332715192673426, '45_180': -22.463889353302736, '45_189': -22.49120681430505, '45_198': -22.452034421474586, '45_207': -22.491462180143916, '45_216': -22.424401805888174, '45_225': -22.434010862901374, '45_234': -22.37844217590856, '45_243': -22.342366749224954, '45_252': -22.335502918167826, '45_261': -22.28028986306962, '45_270': -22.42163556284163, '45_279': -22.45390747381157, '45_288': -22.482381967313852, '45_297': -22.42810849572396, '45_306': -22.3776043696775, '45_315': -22.486542525274547, '45_324': -22.405911968266665, '45_333': -22.46451032699347, '45_342': -22.313383172951973, '45_351': -22.347727397701437, '54_0': -22.22956918366647, '54_9': -22.4215545047007, '54_18': -22.4520100575503, '54_27': -22.39343143089001, '54_36': -22.279586144328775, '54_45': -22.139663392505984, '54_54': -22.41603868974062, '54_63': -22.289313269849465, '54_72': -22.222649238577283, '54_81': -22.384322029698183, '54_90': -22.280961040416503, '54_99': -22.25604670606765, '54_108': -22.29195550980771, '54_117': -22.391209676820132, '54_126': -22.366288329323638, '54_135': -22.29164716563371, '54_144': -22.294259614217395, '54_153': -22.352690179062343, '54_162': -22.4592054865481, '54_171': -22.38415114706541, '54_180': -22.468398156026268, '54_189': -22.402554704631143, '54_198': -22.343592547354362, '54_207': -22.412469516491917, '54_216': -22.40061895434502, '54_225': -22.301919654439118, '54_234': -22.335315594507037, '54_243': -22.46810576533404, '54_252': -22.070776435538736, '54_261': -22.27819254686231, '54_270': -22.3418184778442, '54_279': -22.400910351590046, '54_288': -22.439469590969104, '54_297': -22.15132690254363, '54_306': -21.666380605117084, '54_315': -22.367909680828525, '54_324': -22.318259073493046, '54_333': -22.380186842072742, '54_342': -22.18571751684488, '54_351': -22.412259811930188, '63_0': -22.237598945271216, '63_9': -20.75550404592754, '63_18': -22.303028575984353, '63_27': -22.3281306836336, '63_36': -22.271137096112085, '63_45': -22.124752395847732, '63_54': -18.12554928893459, '63_63': -22.255074799145174, '63_72': -22.42250080706259, '63_81': -22.226238758163728, '63_90': -22.42507035666696, '63_99': -22.2982428586112, '63_108': -22.349703283818535, '63_117': -22.382357810277394, '63_126': -22.35298706947869, '63_135': -22.299716912363593, '63_144': -22.16891218453697, '63_153': -22.318797307380276, '63_162': -22.30081719910188, '63_171': -22.353937324769323, '63_180': -22.10246726113575, '63_189': -22.28657916484667, '63_198': -22.36303855523319, '63_207': -18.464785236312853, '63_216': -22.397694289643212, '63_225': -22.425287220381147, '63_234': -19.942486516332565, '63_243': -22.370869855119185, '63_252': -22.318358747789645, '63_261': -22.230720961027103, '63_270': -22.229811308683914, '63_279': -22.38813239239731, '63_288': -22.462116268466765, '63_297': -22.235622809342615, '63_306': -22.349746882231408, '63_315': -22.385349218012536, '63_324': -22.39624033279974, '63_333': -22.342334669454694, '63_342': -22.116616272578117, '63_351': -13.466371024650478, '72_0': -22.367482702844338, '72_9': -22.26818750743586, '72_18': -22.373882876475854, '72_27': -22.488636405634285, '72_36': -22.030380295470255, '72_45': -22.10203114279945, '72_54': -22.393879100052875, '72_63': -22.332844267410934, '72_72': -22.413503208364695, '72_81': -22.363514932067915, '72_90': -22.334098187617577, '72_99': -22.29377156805218, '72_108': -22.377441967263337, '72_117': -22.290370486959702, '72_126': -22.358155657425215, '72_135': -21.186151853521693, '72_144': -22.407008693729495, '72_153': -22.367915960229745, '72_162': -22.24565867391414, '72_171': -22.389805748134144, '72_180': -22.381171936620564, '72_189': -22.341505186218935, '72_198': -22.480361447189928, '72_207': -22.389891124616042, '72_216': -22.350446253645217, '72_225': -22.353418535407922, '72_234': -22.33343051570308, '72_243': -22.369136255079162, '72_252': -22.36785351547698, '72_261': -22.327712091823013, '72_270': -22.409757707642804, '72_279': -22.477377237717874, '72_288': -22.45709868126464, '72_297': -22.3257505019357, '72_306': -22.448229259559916, '72_315': -22.500597205470303, '72_324': -22.43141371799705, '72_333': -22.307626902497148, '72_342': -22.228863837061294, '72_351': -22.41687230127704, '81_0': -21.752396065490544, '81_9': -22.305492274646248, '81_18': -22.45606737826602, '81_27': -22.45826676638613, '81_36': -22.368275819973945, '81_45': -22.41556233654247, '81_54': -22.47753966394017, '81_63': -22.43618569898249, '81_72': -22.37770296786259, '81_81': -22.46157993925998, '81_90': -22.16197369164627, '81_99': -22.42091456936377, '81_108': -22.3883428628912, '81_117': -22.424488925494828, '81_126': -22.38826750592184, '81_135': -22.468582740017986, '81_144': -22.45963510582542, '81_153': -22.488825438863394, '81_162': -22.500875425501658, '81_171': -22.44332600629439, '81_180': -22.455197556972536, '81_189': -22.450959871154605, '81_198': -22.447080686897355, '81_207': -22.466295095159555, '81_216': -22.44594325089909, '81_225': -22.4104144959965, '81_234': -22.34021914160186, '81_243': -22.426709740107206, '81_252': -22.291095148839915, '81_261': -22.42284243083301, '81_270': -22.479082419604048, '81_279': -22.328313030832092, '81_288': -22.4172133061494, '81_297': -22.418258715558906, '81_306': -21.96267411810804, '81_315': -22.445436615868957, '81_324': -22.45849354629364, '81_333': -22.38714957239334, '81_342': -22.419535426734697, '81_351': -22.361071397103117, '90_0': -22.150679112066474, '90_9': -22.31897477880226, '90_18': -22.390832480916014, '90_27': -22.26354132767092, '90_36': -21.378920103406955, '90_45': -22.296688999885834, '90_54': -22.349648221906588, '90_63': -22.275030542999914, '90_72': -22.372389025452527, '90_81': -22.272356772002453, '90_90': -22.37713203849823, '90_99': -22.372989542794915, '90_108': -8.233108379141571, '90_117': -22.209420997478254, '90_126': -21.806714382031885, '90_135': -21.99735565285398, '90_144': -22.255133943613373, '90_153': -22.37275798716184, '90_162': -22.341058607011913, '90_171': -22.334569323244228, '90_180': -22.359897066351948, '90_189': -22.126723921846786, '90_198': -22.378254389757892, '90_207': -22.30103945411163, '90_216': -22.455472527684385, '90_225': -22.377932689338618, '90_234': -22.030039948380118, '90_243': -22.39814058344834, '90_252': -22.308471962896892, '90_261': -22.332111222322837, '90_270': -22.364915092423505, '90_279': -22.370490058288254, '90_288': -22.13234531520749, '90_297': -22.314368907338004, '90_306': -22.43258683531757, '90_315': -22.315821042158515, '90_324': -22.329884472288217, '90_333': -22.4114854025771, '90_342': -22.37866039571385, '90_351': -22.3172640079737}
    #coords = motorUtils.getCoordString() # Get coords to use as key in baseline dict
    #rssi = readRssi() # Read rssi value
#
    #if coords not in baseline_avgs: # If coord entry not in baseline create it 
    #    baseline_avgs[coords] = 0
    #baseline_avgs[coords] += rssi / setup_sweep_count # Add value to the baseline map 


# Get RSSI value subtracted by baseline average for current position
def getRssiSubBaseline():
    global baseline_avgs
    global comp_value
    coords = motorUtils.getCoordString() # Get coords to use as key in baseline dict
    rssi_value = readRssi() # Read rssi value
    comp_value = rssi_value - baseline_avgs[coords] # Subtract baseline current rssi
    return comp_value

# Get RSSI value subtracted by baseline average for current position
def avgGetRssiSubBaseline(iterations):
    rssi_list = []
    for i in range(iterations):
        rssi_lst.append(getRssiSubBaseline())
    
    return sum(rssi_list)/iterations
    

# Compare current RSSI with baseline and decide if search mode should be activated
def rfCompBaseline(): 
    global comp_value
    thresh_breached_cnt = 0
    for i in range(threshold_confirm_iterations):  # Take 5 readings to confirm threshold breach
        comp_value = getRssiSubBaseline() # Get baseline subtracted rssi
        if comp_value > rssi_threshold: # If reading exceeds threshold
            thresh_breached_cnt += 1    # Increment counter
    if thresh_breached_cnt / threshold_confirm_iterations >= threshold_breach_percentage:  # If 70% readings exceed threshold
        print("Drone detected! Entering search mode.") 
        modes.searchMode()  # Enter search mode